<!DOCTYPE html>
<meta charset="utf-8" />
<html>
  <head>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="./styles.css" />
    <link rel="stylesheet" href="./bar_style.css" />
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"
    ></script>
    <script src="http://d3js.org/d3.v3.js"></script>
  </head>
  <body onload="incrementCount(1300000)">
    <div class="bar">
      <div class="inner_bar">
        <img class="logo" src="./Amazon-Logo.jpg" />
        <a class="header-text h1">Amazon Reviews Visualization</a>
      </div>
    </div>
    <div class="container page-wrapper">
      <div class="row first-column-wrapper">
        <div id="display_div_id"></div>
      </div>
      <div class="row">
        <div class="col-sm-6 heat-map-wrapper">
          <h3>Category</h3>
          <div class="dataset-picker" id="dataset-picker"></div>
          <div class="row">
            <div class="col-sm-12" id="chart"></div>
          </div>
        </div>

        <div class="col-sm-6 second-column-wrapper">
          <h3>Category Analysis</h3>
          <div class="col-sm-12 heat-map-hover" id="table"></div>
          <h3>Rating Distribution</h3>
          <div class="set-picker" id="set-picker"></div>
          <div id="graphic"></div>
        </div>
      </div>
      <div class="row">
        <div class="timeseries-wrapper">
          <h3>Time series data</h3>
          <div id="controllers"></div>
          <div id="Tchart"></div>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js"></script>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/moment.min.js"></script>
          <script src="./script.js"></script>
        </div>
      </div>
      <div class="row">
        <div class="container">
          <div style="text-align:center" id="svgcontainer1"></div>
          <div class="review-container">
            <ol class="review-list"></ol>
          </div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      var selected = "Total";
      var margin = { top: 50, right: 0, bottom: 100, left: 30 },
        width = 960 - margin.left - margin.right,
        height = 600 - margin.top - margin.bottom,
        gridSize = Math.floor(width / 13),
        buckets = 10,
        colors = [
          "#ffffd9",
          "#edf8b1",
          "#c7e9b4",
          "#7fcdbb",
          "#41b6c4",
          "#1d91c0",
          "#225ea8",
          "#253494",
          "#081d58"
        ], // alternatively colorbrewer.YlGnBu[9]
        dataset = [
          ["Total", "./dataTotal.csv"],
          ["Average", "./dataAverage.csv"],
          ["Alphabetical", "./dataName.csv"]
        ];

      var svg = d3
        .select("#chart")
        .append("svg")
        .attr("width", gridSize * 1.75 * 4 + margin.left + margin.right)
        .attr("height", gridSize * 6 + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var heatmapChart = function(csvFile) {
        svg.selectAll(".column").remove();

        d3.csv(csvFile, function(error, data) {
          //for color scale
          var colorScale = d3.scale
            .quantile()
            .domain([
              d3.min(data, function(d) {
                return d.average;
              }),
              buckets - 1,
              d3.max(data, function(d) {
                return d.average;
              })
            ])
            .range(colors);

          var cards = svg
            .selectAll(".column")
            .data(data, function(d) {
              return d.row + ":" + d.column + ":" + d.department;
            })
            .enter();

          cards
            .append("rect")
            .attr("x", function(d) {
              return (d.column - 1) * gridSize * 1.75;
            })
            .attr("y", function(d) {
              return (d.row - 1) * gridSize;
            })
            .attr("rx", 4)
            .attr("ry", 4)
            .attr("class", "column bordered")
            .attr("width", gridSize * 1.75)
            .attr("height", gridSize)
            .attr("cursor", "pointer")
            .style("fill", function(d) {
              return colorScale(d.average);
            })
            //.on("click", click)
            .on("click", click);

          cards
            .append("text")
            .attr("class", "column bordered")
            .attr("x", function(d) {
              return ((d.column - 1) * gridSize + gridSize / 2 - 20) * 1.75;
            })
            .attr("y", function(d) {
              return d.row * gridSize - (gridSize / 2 - 8);
            })
            .attr("cursor", "pointer")
            .text(function(d) {
              return d.department.split("_")[0];
            })
            //.on("click", click)
            .on("click", click);
        });
      };

      var displayBarGraph = function(chartData) {
        var margin = {
          top: 15,
          right: 20,
          bottom: 15,
          left: 30
        };

        var width = 560,
          height = 300;

        d3.select("#graphic")
          .select("svg")
          .remove();

        var svg = d3
          .select("#graphic")
          .append("svg")
          .attr("width", width - margin.left - margin.right)
          .attr("height", height - margin.top - margin.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );

        var x = d3.scale
          .linear()
          .range([0, width / 3])
          .domain([
            0,
            d3.max(chartData, function(d) {
              return d.Average;
            })
          ]);

        var y = d3.scale
          .ordinal()
          .rangeRoundBands([100, 0], 0.25)
          .domain(
            chartData.map(function(d) {
              return d.Category;
            })
          );

        //make y axis to show bar names
        var yAxis = d3.svg
          .axis()
          .scale(y)
          //no tick marks
          .tickSize(0)
          .orient("left");

        var gy = svg
          .append("g")
          .attr("class", "y axis")
          .call(yAxis);

        var bars = svg
          .selectAll(".graph")
          .data(chartData)
          .enter()
          .append("g");

        // double y axis translate
        var transform;
        d3.select("#graphic")
          .select(".axis")
          .selectAll(".tick")
          .attr("transform", function() {
            transform = d3.transform(d3.select(this).attr("transform"));
            return (
              "translate(" +
              transform.translate[0] +
              "," +
              transform.translate[1] * 2 +
              ")"
            );
          });

        //append rects
        bars
          .append("rect")
          .attr("class", "graph")
          .attr("y", function(d) {
            return y(d.Category) * 2;
          })
          .attr("height", y.rangeBand() * 2)
          .attr("x", 0)
          .attr("width", function(d) {
            if (selected == "Total") {
              return x(d.Average) / 10;
            } else {
              return x(d.Average);
            }
          });

        //add a value label to the right of each bar
        bars
          .append("text")
          .attr("class", "label")
          .attr("y", function(d) {
            return y(d.Category) * 2 + y.rangeBand() / 2 + 12;
          })
          //x position is 3 pixels to the right of the bar
          .attr("x", function(d) {
            if (selected == "Total") {
              return x(d.Average) / 10 + 3;
            } else {
              return x(d.Average) + 3;
            }
          })
          .text(function(d) {
            return d.Average;
          });
      };

      function click(d) {
        loadBubbleGraph("jdld");
        d3.select("#table")
          .select("table")
          .remove();

        var data = [
          ["Total Number of Reviews:", d.count],
          ["Average of Reviews:", d.average],
          ["Rank (total):", d.rank_total],
          ["Rank (average):", d.rank_average]
        ];

        //Bar Chart
        var chartData1 = [
          {
            Category: "5#",
            Average: d.Star5
          },
          {
            Category: "4#",
            Average: d.Star4
          },
          {
            Category: "3#",
            Average: d.Star3
          },
          {
            Category: "2#",
            Average: d.Star2
          },
          {
            Category: "1#",
            Average: d.Star1
          }
        ];

        var tot =
          parseInt(d.Star5) +
          parseInt(d.Star4) +
          parseInt(d.Star3) +
          parseInt(d.Star2) +
          parseInt(d.Star1);

        var chartData2 = [
          {
            Category: "5#",
            Average: ((d.Star5 * 100) / tot).toFixed(2)
          },
          {
            Category: "4#",
            Average: ((d.Star4 * 100) / tot).toFixed(2)
          },
          {
            Category: "3#",
            Average: ((d.Star3 * 100) / tot).toFixed(2)
          },
          {
            Category: "2#",
            Average: ((d.Star2 * 100) / tot).toFixed(2)
          },
          {
            Category: "1#",
            Average: ((d.Star1 * 100) / tot).toFixed(2)
          }
        ];
        console.log(selected);

        var charts = [["Total", chartData1], ["Percentage", chartData2]];
        if (selected == "Total") {
          displayBarGraph(chartData1);
        } else {
          displayBarGraph(chartData2);
        }

        var setpicker = d3
          .select("#set-picker")
          .selectAll(".dataset-button")
          .data(charts);

        setpicker
          .enter()
          .append("input")
          .attr("value", function(d) {
            return d[0];
          })
          .attr("type", "button")
          .attr("class", "dataset-button")
          .on("click", function(d) {
            selected = d[0];
            displayBarGraph(d[1]);
            d3.select("#set-picker")
              .selectAll(".dataset-button")
              .attr("style", "deselected");
            d3.select(this).style("background-color", "#fb0");
            d3.select(this).style("border", "none");
            d3.select(this).style("outline", "none");
          });
        console.log(selected);

        //Table
        var table = d3
          .select("#table")
          .append("table")
          .attr("class", "table");

        var HeaderRow = table.append("tr");

        HeaderRow.append("th")
          .text(d.department)
          .attr("colspan", 2);

        var tr = table
          .selectAll("tr.data")
          .data(data)
          .enter()
          .append("tr")
          .attr("class", "datarow");

        tr.append("td")
          .attr("class", "data name")
          .text(function(d) {
            return d[0];
          });

        tr.append("td")
          .attr("class", "data value")
          .text(function(d) {
            return d[1];
          });
      }

      heatmapChart(dataset[1][1]);

      var datasetpicker = d3
        .select("#dataset-picker")
        .selectAll(".dataset-button")
        .data(dataset);

      datasetpicker
        .enter()
        .append("input")
        .attr("value", function(d) {
          return d[0];
        })
        .attr("type", "button")
        .attr("class", "dataset-button")
        .on("click", function(d) {
          heatmapChart(d[1]);
        });
    </script>

    <script>
      var display_str = "";
      var display_div = document.getElementById("display_div_id");

      function incrementCount(current_count) {
        // clear count
        while (display_div.hasChildNodes()) {
          display_div.removeChild(display_div.lastChild);
        }

        display_str = current_count.toString();

        for (var i = 0; i < display_str.length; i++) {
          var new_span = document.createElement("span");
          new_span.className = "num_tiles";
          new_span.innerText = display_str[i];
          display_div.appendChild(new_span);
        }
      }
    </script>
    <script>
      var width = 960,
        height = 500,
        padding = 1.5, // separation between same-color nodes
        clusterPadding = 6, // separation between different-color nodes
        maxRadius = 50;

      //
      //         data1 = data;
      //         console.log(data);
      //         bubbleDisplay();
      //     });
      var loadBubbleGraph = function(categoryName) {
        $.getJSON("./two.json", function(data) {
          var data = data;
          console.log(data);
          data.forEach(function(d) {
            d.frequency = +d.frequency;
          });

          //unique cluster/group id's
          var cs = [];
          data.forEach(function(d) {
            console.log(d.sentiment);
            if (d.sentiment < -0.5) {
              var sent = 1;
            } else if (d.sentiment >= -0.5 && d.sentiment < 0) {
              var sent = 2;
            } else if (d.sentiment == 0) {
              var sent = 3;
            } else if (d.sentiment >= 0 && d.sentiment < 0.5) {
              var sent = 4;
            } else {
              var sent = 5;
            }
            if (!cs.contains(sent)) {
              cs.push(sent);
            }
          });
          console.log(cs);

          var n = data.length, // total number of nodes
            m = cs.length; // number of distinct clusters

          //create clusters and nodes
          var clusters = new Array(m);
          var nodes = [];
          for (var i = 0; i < n; i++) {
            nodes.push(create_nodes(data, i));
          }

          var force = d3.layout
            .force()
            .nodes(nodes)
            .size([width, height])
            .gravity(0.02)
            .charge(0)
            .on("tick", tick)
            .start();

          var svg = d3
            .select("#svgcontainer1")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

          var node = svg
            .selectAll("circle")
            .data(nodes)
            .enter()
            .append("g");

          node
            .append("circle")
            .style("fill", function(d) {
              console.log(d);
              if (parseFloat(d.sentiment) < parseFloat(-0.5)) {
                return "rgb(255,0,0)";
              } else if (
                parseFloat(d.sentiment) >= -0.5 &&
                parseFloat(d.sentiment) < 0
              ) {
                return "rgb(255,146,141)";
              } else if (parseFloat(d.sentiment) == 0) {
                return "rgb(255,165,0)";
              } else if (
                parseFloat(d.sentiment) >= 0 &&
                parseFloat(d.sentiment) < 0.5
              ) {
                return "rgb(145,192,139)";
              } else {
                return "rgb(0,128,0)";
              }
            })
            .attr("r", function(d) {
              return d.radius;
            });

          node
            .append("text")
            .attr("dy", ".3em")
            .style("text-anchor", "middle")
            .text(function(d) {
              return d.text;
            });

          node.on("click", function(d, i) {
            console.log(d);
            $(".review-container").html("");
            $.each(d.reviews, function(key, val) {
              var text = "<li class='review-row'>" + val + "</li>";
              $(".review-container").append(text);
            });
            d3.event.stopPropagation();
          });

          function create_nodes(data, node_counter) {
            console.log(data[node_counter]);
            var i = cs.indexOf(data[node_counter].group),
              r =
                Math.sqrt(((i + 1) / m) * -Math.log(Math.random())) * maxRadius,
              d = {
                cluster: i,
                sentiment: data[node_counter].sentiment,
                reviews: data[node_counter].topReviews,
                radius: data[node_counter].frequency * 20,
                text: data[node_counter].word,
                x:
                  Math.cos((i / m) * 2 * Math.PI) * 200 +
                  width / 2 +
                  Math.random(),
                y:
                  Math.sin((i / m) * 2 * Math.PI) * 200 +
                  height / 2 +
                  Math.random()
              };
            if (!clusters[i] || r > clusters[i].radius) clusters[i] = d;
            return d;
          }

          function tick(e) {
            node
              .each(cluster(10 * e.alpha * e.alpha))
              .each(collide(0.5))
              .attr("transform", function(d) {
                var k = "translate(" + d.x + "," + d.y + ")";
                return k;
              });
          }

          // Move d to be adjacent to the cluster node.
          function cluster(alpha) {
            return function(d) {
              var cluster = clusters[d.cluster];
              if (cluster === d) return;
              var x = d.x - cluster.x,
                y = d.y - cluster.y,
                l = Math.sqrt(x * x + y * y),
                r = d.radius + cluster.radius;
              if (l != r) {
                l = ((l - r) / l) * alpha;
                d.x -= x *= l;
                d.y -= y *= l;
                cluster.x += x;
                cluster.y += y;
              }
            };
          }

          // Resolves collisions between d and all other circles.
          function collide(alpha) {
            var quadtree = d3.geom.quadtree(nodes);
            return function(d) {
              var r = d.radius + maxRadius + Math.max(padding, clusterPadding),
                nx1 = d.x - r,
                nx2 = d.x + r,
                ny1 = d.y - r,
                ny2 = d.y + r;
              quadtree.visit(function(quad, x1, y1, x2, y2) {
                if (quad.point && quad.point !== d) {
                  var x = d.x - quad.point.x,
                    y = d.y - quad.point.y,
                    l = Math.sqrt(x * x + y * y),
                    r =
                      d.radius +
                      quad.point.radius +
                      (d.cluster === quad.point.cluster
                        ? padding
                        : clusterPadding);
                  if (l < r) {
                    l = ((l - r) / l) * alpha;
                    d.x -= x *= l;
                    d.y -= y *= l;
                    quad.point.x += x;
                    quad.point.y += y;
                  }
                }
                return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
              });
            };
          }
        });

        Array.prototype.contains = function(v) {
          for (var i = 0; i < this.length; i++) {
            if (this[i] === v) return true;
          }
          return false;
        };
      };
    </script>
  </body>
</html>
