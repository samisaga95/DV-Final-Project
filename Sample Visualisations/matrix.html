<!DOCTYPE html>
<meta charset="utf-8" />
<html>
  <head>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous">
    <link rel="stylesheet" href="./styles.css">
    <script src="http://d3js.org/d3.v3.js"></script>
  </head>
  <body onload="incrementCount(1300000)">
    <div class="bar">
      <div class="inner_bar">
        <img class="logo"  src="./Amazon-Logo.jpg" />
        <a class="header-text h1">Amazon Reviews Visualization</a>
      </div>
    </div>
    <div class="container page-wrapper">
      <div class="row">
        <div class="col-sm-2 first-column-wrapper" style="background-color:#aaa;">
          <div id="display_div_id"></div>
        </div>
        <div class="col-sm-4 second-column-wrapper" style="background-color:#bbb;">
          <h2>Column 2</h2>
          <p>Some text..</p>
        </div>
        <div class="col-sm-6 heat-map-wrapper">
          <div id="dataset-picker"></div>
          <div class="row">
            <div class="col-sm-6" id="chart"></div>
            <div class="col-sm-6" id="table"></div>
          </div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      var margin = { top: 50, right: 0, bottom: 100, left: 30 },
        width = 960 - margin.left - margin.right,
        height = 430 - margin.top - margin.bottom,
        gridSize = Math.floor(width / 24),
        legendElementWidth = gridSize * 2,
        buckets = 9,
        colors = [
          "#ffffd9",
          "#edf8b1",
          "#c7e9b4",
          "#7fcdbb",
          "#41b6c4",
          "#1d91c0",
          "#225ea8",
          "#253494",
          "#081d58"
        ], // alternatively colorbrewer.YlGnBu[9]
        datasets = [
          "./sampleData.tsv",
          "./sampleData2.tsv"
        ];

      var svg = d3
        .select("#chart")
        .append("svg")
        .attr("width", (width + margin.left + margin.right)/2)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var heatmapChart = function(tsvFile) {
        svg.selectAll(".hour").remove();

        d3.tsv(
          tsvFile,
          function(d) {
            return {
              day: +d.day,
              hour: +d.hour,
              value: +d.value
            };
          },
          function(error, data) {
            //for color scale
            var colorScale = d3.scale
              .quantile()
              .domain([
                0,
                buckets - 1,
                d3.max(data, function(d) {
                  return d.value;
                })
              ])
              .range(colors);

            var cards = svg
              .selectAll(".hour")
              .data(data, function(d) {
                return d.day + ":" + d.hour;
              })
              .enter();

            cards
              .append("rect")
              .attr("x", function(d) {
                return (d.hour - 1) * gridSize;
              })
              .attr("y", function(d) {
                return (d.day - 1) * gridSize;
              })
              .attr("rx", 4)
              .attr("ry", 4)
              .attr("class", "hour bordered")
              .attr("width", gridSize)
              .attr("height", gridSize)
              .style("fill", function(d) {
                return colorScale(d.value);
              })
              .on("click", click);

            cards
              .append("text")
              .attr("class", "hour bordered")
              .attr("x", function(d) {
                return (d.hour - 1) * gridSize + gridSize / 2 - 10;
              })
              .attr("y", function(d) {
                return d.day * gridSize - (gridSize / 2 - 10);
              })
              .text(function(d) {
                return d.value;
              })
              .on("click", click);
          }
        );
      };

      function click(d) {
        d3.select("#table")
          .select("table")
          .remove();

        var data = [
          ["Total Number of Reviews:", d.day],
          ["Average of Reviews:", d.hour],
          ["Rank (# of reviews):", (d.day - 1) * 5 + d.hour]
        ];

        var table = d3.select("#table").append("table");

        var HeaderRow = table.append("tr");

        HeaderRow.append("th").text(d.value);

        var tr = table
          .selectAll("tr.data")
          .data(data)
          .enter()
          .append("tr")
          .attr("class", "datarow");

        d3.selectAll(".datarow")
          .filter(":nth-child(even)")
          .attr("class", "datarow even");

        tr.append("td")
          .attr("class", "data name")
          .text(function(d) {
            return d[0];
          });

        tr.append("td")
          .attr("class", "data value")
          .text(function(d) {
            return d[1];
          });
      }

      heatmapChart(datasets[0]);

      var datasetpicker = d3
        .select("#dataset-picker")
        .selectAll(".dataset-button")
        .data(datasets);

      datasetpicker
        .enter()
        .append("input")
        .attr("value", function(d) {
          return "Dataset";
        })
        .attr("type", "button")
        .attr("class", "dataset-button")
        .on("click", function(d) {
          heatmapChart(d);
        });
    </script>

    <script>
      var display_str = "";
      var display_div = document.getElementById("display_div_id");

      function incrementCount(current_count) {
        // clear count
        while (display_div.hasChildNodes()) {
          display_div.removeChild(display_div.lastChild);
        }

        display_str = current_count.toString();

        for (var i = 0; i < display_str.length; i++) {
          var new_span = document.createElement("span");
          new_span.className = "num_tiles";
          new_span.innerText = display_str[i];
          display_div.appendChild(new_span);
        }
      }
    </script>
  </body>
</html>
