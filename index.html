<!DOCTYPE html>
<meta charset="utf-8" />
<html>
  <head>
    <style>
      .one {
        background: #1f77b4;
      }

      .two {
        background: #2ca02c;
      }

      .three {
        background: #ff7f0e;
      }

      .four {
        background: #ff4500;
      }

      .five {
        background: #ffa500;
      }

      .ltext {
        float: left;
        width: calc(100% - 20px);
      }

      .lcolor {
        width: 10px;
        height: 10px;
        border-radius: 3px;
        float: left;
        margin: 5px 0 5px 10px;
      }

      .lrow {
        background: white;
      }

      .legends {
        position: absolute;
        width: 100px;
        right: 10%;
        top: 30%;
      }

      .slider-wrap {
        position: relative;
      }

      .left {
        width: 40px;
        height: 40px;
        position: absolute;
        background: red;
        left: 0;
        top: 50%;
        z-index: 1000;
        border-radius: 20px;
      }

      .right {
        width: 40px;
        height: 40px;
        position: absolute;
        background: red;
        right: 0;
        top: 50%;
        z-index: 1000;
        border-radius: 20px;
      }

      .slider-container {
        overflow-x: scroll;
      }

      #Tchart {
        position: relative;
        right: 0;
      }
    </style>

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="./bar_style.css" />
    <link rel="stylesheet" href="./styles.css" />
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"
    ></script>
    <script src="https://d3js.org/d3.v3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/moment.min.js"></script>
  </head>
  <body onload="incrementCount(41130000)">
    <div class="bar">
      <div class="inner_bar">
        <img class="logo" src="./Amazon-Logo.jpg" />
        <a class="header-text h1">ReviewHub</a>
      </div>

      <!-- </div> -->
    </div>
    <div class="container page-wrapper">
      <div class="row total-reviews-wrapper">
        <div class="total-reviews">
          <div class="total-numbers" id="display_div_id"></div>
          <h4>Total Reviews:</h4>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-6 heat-map-wrapper">
          <h3 class="prod-header">Product Categories</h3>
          <div class="dataset-picker" id="dataset-picker"></div>
          <div class="row">
            <div class="col-sm-12" id="chart"></div>
          </div>
        </div>

        <div class="col-sm-6 second-column-wrapper">
          <h3 style="padding: 10px 15px;">Category Analysis</h3>
          <div class="col-sm-12 heat-map-hover" id="table"></div>
          <h3 class="heading">Rating Distribution</h3>
          <div class="set-picker" id="set-picker"></div>
          <div id="graphic"></div>
        </div>
      </div>
      <div class="row">
        <h3 class="helpful-heading">Top Helpful Reviews</h3>
        <div class="review-wrapper">
          <div class="review-container1 row"></div>
          <p class="read-more">
            <span id="more" class="button">Read full Reviews</span>
          </p>
        </div>
      </div>
      <div class="row">
        <div class="timeseries-wrapper" style="position:relative;">
          <h3>Time series data</h3>
          <div id="controllers"></div>

          <div class="slider-wrap">
            <div class="slider-container">
              <div id="Tchart"></div>
            </div>
          </div>
          <div class="legends clearfix">
            <div class="lrow clearfix">
              <div class="lcolor five"></div>
              <div class="ltext">Rating 5</div>
            </div>
            <div class="lrow clearfix">
              <div class="lcolor four"></div>
              <div class="ltext">Rating 4</div>
            </div>
            <div class="lrow clearfix">
              <div class="lcolor three"></div>
              <div class="ltext">Rating 3</div>
            </div>
            <div class="lrow clearfix">
              <div class="lcolor two"></div>
              <div class="ltext">Rating 2</div>
            </div>
            <div class="lrow clearfix">
              <div class="lcolor one"></div>
              <div class="ltext">Rating 1</div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="second-column-wrapper col-sm-6">
          <h3 class="heading">Sentiment Analysis</h3>
          <div style="text-align:center" id="svgcontainer1"></div>
        </div>
        <div class="heat-map-wrapper col-sm-6">
          <h3 class="heading">Context Based Reviews</h3>
          <div
            class="review-container"
            style="height: 600px;
          overflow-y: auto;"
          ></div>
        </div>
      </div>
    </div>

    <script>
      var loadTimeSeries = function($, d3, moment, selectedDept) {
        "use strict";
        //  console.log("Entering");
        //  console.log(selectedDept);
        d3.select("#controllers")
          .select("rect")
          .remove();

        d3.select("#controllers")
          .selectAll("ellipse")
          .remove();

        d3.select("#controllers")
          .selectAll("text")
          .remove();

        d3.select("#controllers")
          .selectAll("line")
          .remove();

        d3.select("#controllers")
          .selectAll("svg")
          .remove();

        var dataset = data();
        // *** THE DATA *** //
        function data() {
          var arr = [];
          d3.json(
            "./DataSet/TimeLineData/timeline_" + selectedDept + "_5.json",
            function(data) {
              for (var dt in data) {
                arr.push({
                  date: dt,
                  values: data[dt],
                  float: Math.random() * 1000
                });
              }
            }
          );
          return arr;
        }

        var interval = setInterval(function() {
          if (dataset != null) {
            maincall();
            clearInterval(interval);
          }
        }, 1000);

        function maincall() {
          // *** THE COLORS / KEY *** //
          var colors = [
            ["1", "#1f77b4"],
            ["2", "#2ca02c"],
            ["3", "#ff7f0e"],
            ["4", "#FF4500"],
            ["5", "#FFA500"]
          ];

          // *** SETTINGS *** //
          var settings = (function() {
            var margins = {
              top: 10,
              bottom: 40,
              left: 40,
              right: 100
            };
            var dim = {
              width: 1000,
              height: 400
            };

            return {
              margins: margins,
              dim: dim
            };
          })();

          var renderChart = function(dataset, colors, settings) {
            // setup data for graphing ... re-map data and then stack

            var remapped = colors.map(function(c, i) {
              return dataset.map(function(d, ii) {
                return {
                  x: ii,
                  y: d.values[i]
                };
              });
            });
            //stack
            var stacked = d3.layout.stack()(remapped);

            // *** SCALES *** //
            var x = d3.scale
              .ordinal()
              .domain(
                stacked[0].map(function(d) {
                  return d.x;
                })
              ) //pick one of the mapped arrays' x values for the domain
              .rangeRoundBands([0, 7500]);
            var y = d3.scale
              .linear()
              .domain([
                0,
                d3.max(stacked[stacked.length - 1], function(d) {
                  return d.y0 + d.y;
                })
              ]) //the last mapped arrays' has the cummulative y values (y0)
              .range([0, settings.dim.height]);
            var z = d3.scale.ordinal().range(
              colors.map(function(c) {
                return c[1];
              })
            ); //ordinal scale with the colors

            // *** SETUP THE CHART *** //
            d3.select("#Tchart svg").remove(); //clear out old version
            var svg = d3
              .select("#Tchart")
              .append("svg")
              .attr({
                class: "chart-wrapper",
                width: 7000 + settings.margins.left + settings.margins.right,
                height:
                  settings.dim.height +
                  settings.margins.top +
                  settings.margins.bottom
              });

            var Tchart = svg
              .append("g")
              .attr(
                "transform",
                "translate(" +
                  settings.margins.left +
                  "," +
                  settings.margins.top +
                  ")"
              );

            // Add a group for each column.
            var valgroup = Tchart.selectAll("g.valgroup")
              .data(stacked)
              .enter()
              .append("g")
              .attr("class", "valgroup")
              .style("fill", function(d, i) {
                return z(i);
              })
              .style("stroke", function(d, i) {
                return d3.rgb(z(i)).darker();
              });

            // Add a rect for each date.
            var rect = valgroup
              .selectAll("rect")
              .data(function(d) {
                return d;
              })
              .enter()
              .append("rect")
              .attr("x", function(d) {
                return x(d.x);
              })
              .attr("y", function(d) {
                return settings.dim.height - y(d.y0) - y(d.y);
              })
              .attr("height", function(d) {
                return y(d.y);
              })
              .attr("width", x.rangeBand());

            // *** ADD THE TIME SERIES BOTTOM AXIS *** //
            (function(svg, min, max, settings) {
              //setup the min and max as moment objects
              if (!moment.isMoment(min)) {
                min = moment(min);
                if (!min.isValid()) {
                  throw new Error("Invalid min date: " + min);
                }
              }
              if (!moment.isMoment(max)) {
                max = moment(max);
                if (!max.isValid()) {
                  throw new Error("Invalid max date: " + max);
                }
              }

              // *** SETUP THE TIME SERIES AXIS *** //
              var timeScale = d3.time
                .scale()
                .domain([min.toDate(), max.toDate()])
                .range([0, 7500]);

              //create the x-axis from the time scale
              var xAxis = (function(timeScale, min, max) {
                var tickInterval,
                  tickFormat,
                  tickStep = 1,
                  duration = moment.duration(max.diff(min));
                //tickInterval = d3.time.month;
                //          tickFormat = "%b '%y";

                if (duration.asMonths() > 5) {
                  tickInterval = d3.time.month;
                  tickFormat = "%b '%y";
                } else if (duration.asWeeks() > 5) {
                  tickInterval = d3.time.week;
                  tickFormat = "%b %d";
                } else {
                  tickInterval = d3.time.day;
                  tickFormat = "%b %d";
                  tickStep = Math.ceil(duration.days() / 10);
                }

                return d3.svg
                  .axis()
                  .orient("bottom")
                  .scale(timeScale)
                  .ticks(tickInterval, tickStep)
                  .tickSize(1)
                  .tickPadding(5)
                  .tickFormat(d3.time.format(tickFormat));
              })(timeScale, min, max);

              //draw the axis
              svg
                .append("g")
                .attr("class", "x-axis")
                .attr(
                  "transform",
                  "translate(" +
                    settings.margins.left +
                    "," +
                    (settings.dim.height + settings.margins.top) +
                    ")"
                )
                .call(xAxis);

              var y = d3.scale
                .linear()
                .domain([0, 150])
                .range([400, 0]);

              var yAxis = d3.svg
                .axis()
                .scale(y)
                .orient("left")
                .ticks(10);

              svg
                .append("g")
                .attr("class", "y-axis")
                .attr(
                  "transform",
                  "translate(" +
                    settings.margins.left +
                    "," +
                    settings.margins.top +
                    ")"
                )
                .attr("stroke-width", "2")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("Review Count")
                .style("fill", "white");
            })(
              svg,
              dataset[0].date,
              dataset[dataset.length - 1].date,
              settings
            );

            d3.select(".chart-wrapper")
              .selectAll("text")
              .style("fill", "white");

            return svg;
          }; // end renderChart //

          var renderSlider = function(dataset, settings, callback) {
            var RangeSlider = function(
              svg,
              width,
              radius,
              color,
              translater,
              callback
            ) {
              var self = this,
                elements = {
                  min: { value: 0 },
                  max: { value: width }
                },
                settings = {
                  min: 0,
                  max: width,
                  radius: radius,
                  offset: Math.floor(radius / 2),
                  color: color,
                  opacity: {
                    full: 1.0,
                    medium: 0.8,
                    half: 0.5,
                    light: 0.3
                  },
                  translater: translater,
                  callback: callback
                };

              //build the bar
              elements.$bar = svg.append("rect").attr({
                x: settings.offset,
                width: settings.max - settings.offset * 2,
                y: settings.offset,
                height: settings.radius,
                fill: settings.color,
                "fill-opacity": settings.opacity.half
              });

              //build the handles
              elements.$min = svg
                .append("ellipse")
                .style("cursor", "pointer")
                .attr({
                  cx: settings.min,
                  cy: settings.radius,
                  rx: settings.radius,
                  ry: settings.radius,
                  fill: settings.color,
                  "fill-opacity": settings.opacity.medium
                });
              elements.$minText = svg
                .append("text")
                .attr({
                  x: settings.min,
                  y: settings.radius * 3 + settings.offset,
                  fill: "white",
                  "fill-opacity": settings.opacity.medium,
                  "text-anchor": "middle"
                })
                .text(settings.translater.apply(self, [settings.min]).text);

              elements.$max = svg
                .append("ellipse")
                .style("cursor", "pointer")
                .attr({
                  cx: settings.max,
                  cy: settings.radius,
                  rx: settings.radius,
                  ry: settings.radius,
                  fill: settings.color,
                  "fill-opacity": settings.opacity.medium
                });
              elements.$maxText = svg
                .append("text")
                .attr({
                  x: settings.max,
                  y: settings.radius * 3 + settings.offset,
                  fill: "white",
                  "fill-opacity": settings.opacity.medium,
                  "text-anchor": "middle"
                })
                .text(settings.translater.apply(self, [settings.max]).text);

              //expose as public properties
              self.elements = elements;
              self.settings = settings;

              //setup additional methods
              self.init();
            };

            RangeSlider.prototype.init = function() {
              var self = this,
                api = {};

              var runCallback = function(process) {
                if (self.settings.callback) {
                  self.settings.callback.apply(self, [
                    process,
                    self.settings.translater.apply(self, [
                      self.elements.min.value
                    ]),
                    self.settings.translater.apply(self, [
                      self.elements.max.value
                    ])
                  ]);
                }
              };

              self.move = (function(self) {
                var api = {};

                var resetBar = function(x, width) {
                  //no error checking
                  self.elements.$bar.attr({
                    x: Math.max(x - self.settings.offset, 0),
                    width: Math.max(width, 0)
                  });
                };

                api.$min = function(x) {
                  if (x >= self.settings.min && x <= self.elements.max.value) {
                    self.elements.min.value = x;
                    self.elements.$min.attr("cx", x);
                    self.elements.$minText
                      .attr("x", x)
                      .text(self.settings.translater.apply(self, [x]).text);
                    resetBar(x, self.elements.max.value - x);
                    runCallback("move");
                  }
                  return self; //chain-able
                };
                api.$max = function(x) {
                  if (x >= self.elements.min.value && x <= self.settings.max) {
                    self.elements.max.value = x;
                    self.elements.$max.attr("cx", x);
                    self.elements.$maxText
                      .attr("x", x)
                      .text(self.settings.translater.apply(self, [x]).text);
                    resetBar(
                      self.elements.min.value,
                      x - self.elements.min.value
                    );
                    runCallback("move");
                  }
                  return self; //chain-able
                };

                return api;
              })(self);

              self.dragstart = (function(self) {
                var api = {};

                var render = function($element, $text) {
                  $element.attr("fill-opacity", self.settings.opacity.full);
                  $text.attr("fill-opacity", self.settings.full);
                  self.elements.$bar.attr(
                    "fill-opacity",
                    self.settings.opacity.light
                  );
                  runCallback("dragstart");
                };
                api.$min = function() {
                  render(self.elements.$min, self.elements.$minText);
                  return self;
                };
                api.$max = function() {
                  render(self.elements.$max, self.elements.$maxText);
                  return self;
                };

                return api;
              })(self);

              self.dragend = (function(self) {
                var api = {};

                var render = function($element, $text) {
                  $element.attr("fill-opacity", self.settings.opacity.medium);
                  $text.attr("fill-opacity", self.settings.medium);
                  self.elements.$bar.attr(
                    "fill-opacity",
                    self.settings.opacity.half
                  );
                  runCallback("dragend");
                };
                api.$min = function() {
                  render(self.elements.$min, self.elements.$minText);
                  return self;
                };
                api.$max = function() {
                  render(self.elements.$max, self.elements.$maxText);
                  return self;
                };

                return api;
              })(self);

              return self;
            };

            var svg = d3
              .select("#controllers")
              .append("svg")
              .attr({
                width:
                  settings.dim.width +
                  settings.margins.left +
                  settings.margins.right,
                height: 50
              });

            var min = moment(dataset[0].date),
              max = moment(dataset[dataset.length - 1].date),
              handles = {
                size: 12
              };

            var timeScale = d3.time
              .scale()
              .domain([min.toDate(), max.toDate()])
              .range([0, settings.dim.width]);

            //setup the svg container
            var svg = d3
              .select("#controllers")
              .append("svg")
              .attr({
                width: 1000 + settings.margins.left + settings.margins.right,
                height: 50
              });
            var g = svg
              .append("g")
              .attr("class", "x-axis")
              .attr("class", "line-slider")
              .attr("transform", "translate(" + settings.margins.left + ",0)");

            //draw the axis
            g.append("line").attr({
              x1: 0,
              y1: handles.size,
              x2: settings.dim.width,
              y2: handles.size,
              stroke: "#ccc",
              "stroke-width": 1
            });

            var translater = (function(timeScale) {
              return function(x) {
                var m = moment(timeScale.invert(x)),
                  ret = {
                    x: x,
                    text: null,
                    value: m
                  };

                if (m.isValid()) {
                  ret.text = m.format("MMM. DD, YYYY");
                }
                return ret;
              };
            })(timeScale);

            var slider = new RangeSlider(
              g,
              settings.dim.width,
              handles.size,
              "red",
              translater,
              callback
            );

            //      console.log("slider", slider);

            //setup handle dragging
            slider.elements.$min.call(
              d3.behavior
                .drag()
                .on("dragstart", slider.dragstart.$min)
                .on("drag", function() {
                  slider.move.$min(d3.event.x);
                })
                .on("dragend", slider.dragend.$min)
            );
            slider.elements.$max.call(
              d3.behavior
                .drag()
                .on("dragstart", slider.dragstart.$max)
                .on("drag", function() {
                  slider.move.$max(d3.event.x);
                })
                .on("dragend", slider.dragend.$max)
            );
          };

          var updateChart = (function(dataset, colors, settings) {
            //draw for the first time
            var svg = renderChart(dataset, colors, settings);

            var filterData = function(dstart, dend) {
              //because .isBetween is exclusive, adjust these boundaries
              dstart = dstart.subtract(1, "minute");
              dend = dend.add(1, "minute");

              return dataset.filter(function(d) {
                return moment(d.date).isBetween(dstart, dend);
              });
            };

            var callback = function(process, dstart, dend) {
              if (process === "dragend") {
                var data = filterData(dstart.value, dend.value);
                svg.attr("opacity", 1);
                svg = renderChart(data, colors, settings);
              } else if (process === "dragstart") {
                svg.attr("opacity", 0.5);
              }
            };

            return callback;
          })(dataset, colors, settings);

          renderSlider(dataset, settings, updateChart);
        }
      };
    </script>
    <script>
      var $el,
        $ps,
        $up,
        totalHeight,
        reviewNumber = 3,
        maxHeight,
        moreText,
        flag = 0;
      var loadHelpfulReviews = function loadHelpfulReviews(rating) {
        var filename = "./Dataset/UsefulRev/help_" + selectedDept + "_5.json";

        $("#more").html("Read full Reviews");
        $(".review-wrapper").css("height", "300px");
        flag = 0;
        $.getJSON(filename, function(data) {
          var data = data;

          var topReviews = "review_" + 3;
          var productIDS = "product_" + 3;
          var score = "score_" + 3;
          var selectedData = data[0];
          var wordObj = {
            reviews: selectedData[topReviews],
            productId: selectedData[productIDS],
            helpful: selectedData[score]
          };
          if (rating) {
            reviewNumber = rating.Category.charAt(0) || 3;
            topReviews = "review_" + reviewNumber;
            productIDS = "product_" + reviewNumber;
            score = "score_" + reviewNumber;
            var wordObj = {
              reviews: selectedData[topReviews],
              productId: selectedData[productIDS],
              helpful: selectedData[score]
            };
          }

          $(".helpful-heading").html(
            "Top Helpful Reviews for Rating #" + reviewNumber
          );
          $(".review-container1").html("");
          $.each(wordObj.reviews, function(key, val) {
            var card =
              "<div class='col-sm-3' style='padding: 0px 5px;'" +
              "<div class='card col-sm-12''><div class='card-body' style='width: 100%;margin : 0.5rem 0;background-color: #ffba00;color:black;'>" +
              "<h5 class='card-title' style='font-weight: bold;'>" +
              wordObj.productId[key] +
              "</h5>" +
              "<p class='card-text'>" +
              val +
              "</p></div></div></div>";
            $(".review-container1").append(card);
          });
        });
      };

      $("body").on("click", ".read-more", function(e) {
        e.stopPropagation();
        e.preventDefault();
        totalHeight = 0;
        maxHeight = 0;

        $el = $(this).find("span");
        $p = $(this);
        moreText = $el.html();
        //read-more
        $up = $p.parent();
        //review-wrapper(up)
        var arr = $up.find("p:not('.read-more')");

        if (moreText == "Read full Reviews" && flag == 0) {
          flag = 1;
          // measure how tall inside should be by adding together heights of all inside paragraphs (except read-more paragraph)
          for (var i = 0; i < arr.length; i++) {
            if (maxHeight < arr[i].offsetHeight) {
              maxHeight = arr[i].offsetHeight;
            }
          }
          totalHeight = maxHeight + 120;

          $up
            .css({
              // Set height to prevent instant jumpdown when max height is removed
              height: totalHeight,
              "max-height": 9999
            })
            .animate({
              height: totalHeight
            });
          $el.html("See Less");
          // fade out read-more
          $p.fadeTo(1000, 1);
          return false;
        } else if (moreText == "See Less" && flag == 1) {
          flag = 0;
          $up
            .css({
              // Set height to prevent instant jumpdown when max height is removed
              height: $up.height(),
              "max-height": 300
            })
            .animate({
              height: $up.height()
            });
          // fade out read-more
          $p.fadeTo(1000, 1);
          $el.html("Read full Reviews");
          return false;
        }
      });
    </script>
    <script>
      var width = 520,
        height = 500,
        padding = 1.5, // separation between same-color nodes
        clusterPadding = 6, // separation between different-color nodes
        maxRadius = 50;

      var loadBubbleGraph = function(categoryName) {
        var filename =
          "./Dataset/BubbleChartData/output_" + categoryName + "_5.json";
        var onClick = function(d) {
          selectedWord = d.text;

          d3.select("#svgcontainer1")
            .select("svg")
            .selectAll("text")
            .attr("stroke", function(d) {
              if (d.text == selectedWord) {
                return "#fff";
              } else {
                return "black";
              }
            })
            .attr("fill", function(d) {
              if (d.text == selectedWord) {
                return "#fff";
              } else {
                return "black";
              }
            });

          $(".review-container").html("");
          $.each(d.reviews, function(key, val) {
            var card =
              "<div class='card' style='width: 100%;margin : 0.5rem 0;background-color: #ffba00;'><div class='card-body'><h5 class='card-title' style='font-weight: bold;'>" +
              d.productId[key] +
              "</h5>" +
              "<p class='card-text'>" +
              val +
              "</p></div></div>";
            $(".review-container").append(card);
          });
        };
        var width = 600,
          height = 600,
          padding = 1.5, // separation between same-color nodes
          clusterPadding = 6, // separation between different-color nodes
          maxRadius = 50;

        d3.select("#svgcontainer1")
          .selectAll("svg")
          .remove();

        $.getJSON(filename, function(data) {
          var data = data;
          var maxfreq = 0;
          var selectedWord = data[0].word;
          var wordObj = {
            cluster: 0,
            sentiment: data[0].sentiment,
            reviews: data[0].topReviews,
            productId: data[0].productIDS,
            radius: data[0].frequency * 1,
            text: data[0].word,
            // rating: data[0].ratings,
            productIDS: data[0].productIDS,
            x: 0,
            y: 0
          };
          onClick(wordObj);

          data.forEach(function(d) {
            if (d.frequency > maxfreq) {
              maxfreq = d.frequency;
            }
            d.frequency = +d.frequency;
          });

          //unique cluster/group id's
          var cs = [];
          data.forEach(function(d) {
            if (d.sentiment < -0.5) {
              var sent = 1;
            } else if (d.sentiment >= -0.5 && d.sentiment < 0) {
              var sent = 2;
            } else if (d.sentiment == 0) {
              var sent = 3;
            } else if (d.sentiment >= 0 && d.sentiment < 0.5) {
              var sent = 4;
            } else {
              var sent = 5;
            }
            if (!cs.contains(sent)) {
              cs.push(sent);
            }
          });

          var n = data.length, // total number of nodes
            m = cs.length; // number of distinct clusters

          //create clusters and nodes
          var clusters = new Array(m);
          var nodes = [];
          for (var i = 0; i < n; i++) {
            nodes.push(create_nodes(data, i));
          }

          var force = d3.layout
            .force()
            .nodes(nodes)
            .size([width, height])
            .gravity(0.02)
            .charge(0)
            .on("tick", tick)
            .start();

          var svg = d3
            .select("#svgcontainer1")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

          var node = svg
            .selectAll("circle")
            .data(nodes)
            .enter()
            .append("g");

          node
            .append("circle")
            .attr("cursor", "pointer")
            .style("fill", function(d) {
              if (parseFloat(d.sentiment) < parseFloat(-0.5)) {
                return "rgb(255,0,0)";
              } else if (
                parseFloat(d.sentiment) >= -0.5 &&
                parseFloat(d.sentiment) < 0
              ) {
                return "rgb(255,146,141)";
              } else if (parseFloat(d.sentiment) == 0) {
                return "rgb(255,165,0)";
              } else if (
                parseFloat(d.sentiment) >= 0 &&
                parseFloat(d.sentiment) < 0.5
              ) {
                return "rgb(145,192,139)";
              } else {
                return "rgb(0,128,0)";
              }
            })
            .attr("r", function(d) {
              return d.radius;
            });

          node
            .append("text")
            .attr("dy", ".3em")
            .attr("cursor", "pointer")
            .attr("stroke", function(d) {
              if (d.text == selectedWord) {
                return "#fff";
              } else {
                return "black";
              }
            })
            .attr("fill", function(d) {
              if (d.text == selectedWord) {
                return "#fff";
              } else {
                return "black";
              }
            })
            .attr("font-weight", function(d) {
              if (d.text == selectedWord) {
                return "700";
              } else {
                return "300";
              }
            })
            .style("text-anchor", "middle")
            .text(function(d) {
              return d.text;
            });

          node.on("click", function(d) {
            onClick(d);
          });

          function create_nodes(data, node_counter) {
            var multiplier = width / (maxfreq * 7);

            var i = cs.indexOf(data[node_counter].group),
              r =
                Math.sqrt(((i + 1) / m) * -Math.log(Math.random())) * maxRadius,
              d = {
                cluster: i,
                sentiment: data[node_counter].sentiment,
                reviews: data[node_counter].topReviews,
                radius: data[node_counter].frequency * multiplier,
                text: data[node_counter].word,
                productId: data[node_counter].productIDS,
                x:
                  Math.cos((i / m) * 2 * Math.PI) * 200 +
                  width / 2 +
                  Math.random(),
                y:
                  Math.sin((i / m) * 2 * Math.PI) * 200 +
                  height / 2 +
                  Math.random()
              };
            if (!clusters[i] || r > clusters[i].radius) clusters[i] = d;
            return d;
          }

          function tick(e) {
            node
              .each(cluster(10 * e.alpha * e.alpha))
              .each(collide(0.5))
              .attr("transform", function(d) {
                var k = "translate(" + d.x + "," + d.y + ")";
                return k;
              });
          }

          // Move d to be adjacent to the cluster node.
          function cluster(alpha) {
            return function(d) {
              var cluster = clusters[d.cluster];
              if (cluster === d) return;
              var x = d.x - cluster.x,
                y = d.y - cluster.y,
                l = Math.sqrt(x * x + y * y),
                r = d.radius + cluster.radius;
              if (l != r) {
                l = ((l - r) / l) * alpha;
                d.x -= x *= l;
                d.y -= y *= l;
                cluster.x += x;
                cluster.y += y;
              }
            };
          }

          // Resolves collisions between d and all other circles.
          function collide(alpha) {
            var quadtree = d3.geom.quadtree(nodes);
            return function(d) {
              var r = d.radius + maxRadius + Math.max(padding, clusterPadding),
                nx1 = d.x - r,
                nx2 = d.x + r,
                ny1 = d.y - r,
                ny2 = d.y + r;
              quadtree.visit(function(quad, x1, y1, x2, y2) {
                if (quad.point && quad.point !== d) {
                  var x = d.x - quad.point.x,
                    y = d.y - quad.point.y,
                    l = Math.sqrt(x * x + y * y),
                    r =
                      d.radius +
                      quad.point.radius +
                      (d.cluster === quad.point.cluster
                        ? padding
                        : clusterPadding);
                  if (l < r) {
                    l = ((l - r) / l) * alpha;
                    d.x -= x *= l;
                    d.y -= y *= l;
                    quad.point.x += x;
                    quad.point.y += y;
                  }
                }
                return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
              });
            };
          }
        });

        Array.prototype.contains = function(v) {
          for (var i = 0; i < this.length; i++) {
            if (this[i] === v) return true;
          }
          return false;
        };
      };
    </script>

    <script type="text/javascript">
      var selected = "Percentage";
      var selectedDept = "Health_and_Personal_Care";

      var margin = { top: 50, right: 0, bottom: 100, left: 50 },
        width = 960 - margin.left - margin.right,
        height = 600 - margin.top - margin.bottom,
        gridSize = Math.floor(width / 13),
        buckets = 10,
        colors = [
          "#ffffff",
          "#cccccc",
          "#999",
          "#666",
          "#333",
          "#1d91c0",
          "#225ea8",
          "#253494",
          "#081d58"
        ], // alternatively colorbrewer.YlGnBu[9]
        textColors = [
          "#333",
          "#333",
          "#111",
          "#fff",
          "#fff",
          "#333",
          "#333",
          "#333",
          "#fff"
        ],
        dataset = [
          ["Total Reviews", "./dataTotal.csv"],
          ["Average of Ratings", "./dataAverage.csv"],
          ["Alphabetical Order", "./dataName.csv"]
        ];

      var svg = d3
        .select("#chart")
        .append("svg")
        .attr("width", gridSize * 1.75 * 4 + margin.left + margin.right)
        .attr("height", gridSize * 6 + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var heatmapChart = function(csvFile) {
        svg.selectAll(".column").remove();

        d3.csv(csvFile, function(error, data) {
          //for color scale
          var colorScale = d3.scale
            .quantile()
            .domain([
              d3.min(data, function(d) {
                return d.average;
              }),
              buckets - 1,
              d3.max(data, function(d) {
                return d.average;
              })
            ])
            .range(colors);

          var textColorScale = d3.scale
            .quantile()
            .domain([
              d3.min(data, function(d) {
                return d.average;
              }),
              buckets - 1,
              d3.max(data, function(d) {
                return d.average;
              })
            ])
            .range(textColors);

          // double y axis translate
          var transform;
          d3.select("#chart")
            .select(".axis")
            .selectAll(".tick")
            .attr("transform", function() {
              transform = d3.transform(d3.select(this).attr("transform"));
              return (
                "translate(" +
                transform.translate[0] +
                "," +
                transform.translate[1] * 2 +
                ")"
              );
            });

          var cards = svg
            .selectAll(".column")
            .data(data, function(d) {
              return d.row + ":" + d.column + ":" + d.department;
            })
            .enter();

          cards
            .append("rect")
            .attr("x", function(d) {
              return (d.column - 1) * gridSize * 1.75;
            })
            .attr("y", function(d) {
              return (d.row - 1) * gridSize;
            })
            .attr("rx", 4)
            .attr("ry", 4)
            .attr("class", "column bordered")
            .attr("width", gridSize * 1.75)
            .attr("height", gridSize)
            .attr("cursor", "pointer")
            .attr("selected", function(d) {
              if (d.department == selectedDept) {
                click(d);
                return true;
              } else {
                return false;
              }
            })
            .style("fill", function(d) {
              if (d3.select(this).attr("selected") == "true") {
                return "#fb0";
              } else {
                return colorScale(d.average);
              }
            })
            .on("click", function(d) {
              selectedDept = d.department;

              d3.select("#chart")
                .selectAll("rect")
                .style("fill", function(d) {
                  return colorScale(d.average);
                })
                .selectAll("text")
                .style("fill", function(d) {
                  return textColorScale(d.average);
                });

              d3.select("#chart")
                .selectAll("rect")
                .attr("selected", false);
              d3.select(this)
                .attr("selected", true)
                .style("fill", "fb0");

              loadHelpfulReviews({ Category: "3#" });
              click(d);
            });

          cards
            .append("text")
            .attr("class", "column bordered")
            .attr("x", function(d) {
              return ((d.column - 1) * gridSize + gridSize / 2 - 20) * 1.75;
            })
            .attr("y", function(d) {
              return d.row * gridSize - (gridSize / 2 - 8);
            })
            .attr("cursor", "pointer")
            .style("fill", function(d) {
              return textColorScale(d.average);
            })
            .text(function(d) {
              return d.department.split("_")[0];
            })
            .on("click", function(d) {
              loadHelpfulReviews({ Category: "3#" });
            });
        });
      };

      var displayBarGraph = function(chartData) {
        var margin = {
          top: 15,
          right: 20,
          bottom: 15,
          left: 30
        };

        var width = 650,
          height = 300;

        d3.select("#graphic")
          .select("svg")
          .remove();

        var svg = d3
          .select("#graphic")
          .append("svg")
          .attr("width", width - margin.left - margin.right)
          .attr("height", height - margin.top - margin.bottom)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );

        var domainMax = Math.max.apply(
          Math,
          chartData.map(function(obj) {
            return obj.Average;
          })
        );
        domainMax = domainMax + domainMax / 3.75;

        var x = d3.scale
          .linear()
          .range([0, width])
          .domain([0, domainMax]);

        var y = d3.scale
          .ordinal()
          .rangeRoundBands([100, 0], 0.25)
          .domain(
            chartData.map(function(d) {
              return d.Category;
            })
          );

        //make y axis to show bar names
        var yAxis = d3.svg
          .axis()
          .scale(y)
          //no tick marks
          .tickSize(0)
          .orient("left");

        var gy = svg
          .append("g")
          .attr("class", "y axis")
          .call(yAxis);

        var bars = svg
          .selectAll(".graph")
          .data(chartData)
          .enter()
          .append("g");

        // double y axis translate
        var transform;
        d3.select("#graphic")
          .select(".axis")
          .selectAll(".tick")
          .attr("transform", function() {
            transform = d3.transform(d3.select(this).attr("transform"));
            return (
              "translate(" +
              transform.translate[0] +
              "," +
              transform.translate[1] * 2 +
              ")"
            );
          });

        //append rects
        bars
          .append("rect")
          .attr("class", "graph")
          .attr("cursor", "pointer")
          .attr("y", function(d) {
            return y(d.Category) * 2;
          })
          .attr("height", y.rangeBand() * 2)
          .attr("x", 0)
          .attr("width", 0)
          .transition()
          .delay(function(d, i) {
            return i * 100;
          })
          .attr("width", function(d) {
            return x(d.Average);
          });

        bars.on("click", function(d) {
          //document.getElementById('#more').innerText = "Read full Reviews";
          loadHelpfulReviews(d);
        });

        //add a value label to the right of each bar
        bars
          .append("text")
          .attr("class", "label")
          .attr("y", function(d) {
            return y(d.Category) * 2 + y.rangeBand() / 2 + 12;
          })
          .attr("x", 0)
          .transition()
          .delay(function(d, i) {
            return i * 100;
          })
          //x position is 3 pixels to the right of the bar
          .attr("x", function(d) {
            return x(d.Average) + 3;
          })

          .text(function(d) {
            if (selected == "Percentage") {
              return d.Average + "%";
            } else {
              return d.Average;
            }
          });
      };

      function click(d) {
        loadHelpfulReviews({ Category: "3#" });
        loadBubbleGraph(selectedDept);
        loadTimeSeries(jQuery, window.d3, window.moment, selectedDept);
        d3.select("#table")
          .select("table")
          .remove();

        var data = [
          ["Total Number of Reviews:", d.count],
          ["Average of Reviews:", d.average],
          ["Rank (total):", d.rank_total],
          ["Rank (average):", d.rank_average]
        ];

        //Bar Chart
        var chartData1 = [
          {
            Category: "5#",
            Average: d.Star5
          },
          {
            Category: "4#",
            Average: d.Star4
          },
          {
            Category: "3#",
            Average: d.Star3
          },
          {
            Category: "2#",
            Average: d.Star2
          },
          {
            Category: "1#",
            Average: d.Star1
          }
        ];

        var tot =
          parseInt(d.Star5) +
          parseInt(d.Star4) +
          parseInt(d.Star3) +
          parseInt(d.Star2) +
          parseInt(d.Star1);

        var chartData2 = [
          {
            Category: "5#",
            Average: ((d.Star5 * 100) / tot).toFixed(2)
          },
          {
            Category: "4#",
            Average: ((d.Star4 * 100) / tot).toFixed(2)
          },
          {
            Category: "3#",
            Average: ((d.Star3 * 100) / tot).toFixed(2)
          },
          {
            Category: "2#",
            Average: ((d.Star2 * 100) / tot).toFixed(2)
          },
          {
            Category: "1#",
            Average: ((d.Star1 * 100) / tot).toFixed(2)
          }
        ];

        var charts = [["Total", chartData1], ["Percentage", chartData2]];
        if (selected == "Total") {
          displayBarGraph(chartData1);
        } else {
          displayBarGraph(chartData2);
        }

        var setpicker = d3
          .select("#set-picker")
          .selectAll(".dataset-button")
          .data(charts);

        setpicker
          .enter()
          .append("input")
          .attr("value", function(d) {
            return d[0];
          })
          .attr("type", "button")
          .attr("class", "dataset-button highlight2")
          .on("click", function(d) {
            selected = d[0];
            displayBarGraph(d[1]);
            d3.select("#set-picker")
              .selectAll(".dataset-button")
              .attr("class", "dataset-button")
              .attr("style", "deselected");
            d3.select(this).style("background-color", "#fb0");
            d3.select(this).style("border", "none");
            d3.select(this).style("outline", "none");
          });

        //Table
        var table = d3
          .select("#table")
          .append("table")
          .attr("class", "table");

        var HeaderRow = table.append("tr");

        HeaderRow.append("th")
          .text(d.department)
          .attr("colspan", 2);

        var tr = table
          .selectAll("tr.data")
          .data(data)
          .enter()
          .append("tr")
          .attr("class", "datarow");

        tr.append("td")
          .attr("class", "data name")
          .text(function(d) {
            return d[0];
          });

        tr.append("td")
          .attr("class", "data value")
          .text(function(d) {
            return d[1];
          });
      }

      heatmapChart(dataset[1][1]);

      var datasetpicker = d3
        .select("#dataset-picker")
        .selectAll(".dataset-button")
        .data(dataset);

      datasetpicker
        .enter()
        .append("input")
        .attr("value", function(d) {
          return d[0];
        })
        .attr("type", "button")
        .attr("class", "dataset-button highlight")
        .on("click", function(d) {
          heatmapChart(d[1]);
          d3.select("#dataset-picker")
            .selectAll(".dataset-button")
            .attr("style", "deselected")
            .attr("class", "dataset-button");
          d3.select(this).style("background-color", "#fb0");
          d3.select(this).style("border", "none");
          d3.select(this).style("outline", "none");
        });
    </script>
    <script>
      var display_str = "";
      var display_div = document.getElementById("display_div_id");

      function incrementCount(current_count) {
        // clear count
        while (display_div.hasChildNodes()) {
          display_div.removeChild(display_div.lastChild);
        }

        display_str = current_count.toString();

        for (var i = 0; i < display_str.length; i++) {
          var new_span = document.createElement("span");
          new_span.className = "num_tiles";
          new_span.innerText = display_str[i];
          display_div.appendChild(new_span);
        }
      }
    </script>
  </body>
</html>
